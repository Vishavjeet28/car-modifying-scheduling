{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}{{ form_action }} Service - Admin Panel{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'admin_panel:service_list' %}">Services</a></li>
    <li class="breadcrumb-item active">{{ form_action }} Service</li>
{% endblock %}

{% block page_title %}{{ form_action }} Service{% endblock %}

{% block page_actions %}
    <a href="{% url 'admin_panel:service_list' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to Services
    </a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-{% if form_action == 'Create' %}plus-circle{% else %}pencil{% endif %} me-2"></i>
                    {{ form_action }} Service
                </h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="service-form">
                    {% csrf_token %}
                    
                    <!-- Service Name -->
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            Service Name <span class="text-danger">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.name.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Enter a unique name for the service.</div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            Description <span class="text-danger">*</span>
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Provide a detailed description of the service.</div>
                    </div>
                    
                    <!-- Category and Status Row -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="{{ form.category.id_for_label }}" class="form-label">
                                    Category <span class="text-danger">*</span>
                                </label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.category.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <div class="form-check">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        Active Service
                                    </label>
                                </div>
                                {% if form.is_active.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.is_active.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price and Duration Row -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.base_price.id_for_label }}" class="form-label">
                                    Base Price (₹) <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    {{ form.base_price }}
                                </div>
                                {% if form.base_price.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.base_price.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Base price for the service. Additional pricing variants can be added later.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.estimated_duration.id_for_label }}" class="form-label">
                                    Estimated Duration <span class="text-danger">*</span>
                                </label>
                                {{ form.estimated_duration }}
                                {% if form.estimated_duration.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.estimated_duration.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Format: HH:MM:SS (e.g., 02:30:00 for 2.5 hours)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Service Image -->
                    <div class="mb-4">
                        <label for="{{ form.image.id_for_label }}" class="form-label">Service Image</label>
                        
                        {% if object.image %}
                            <div class="mb-3">
                                <div class="d-flex align-items-center">
                                    <img src="{{ object.image.url }}" alt="{{ object.name }}" 
                                         class="img-thumbnail me-3" style="width: 100px; height: 100px; object-fit: cover;">
                                    <div>
                                        <p class="mb-1"><strong>Current Image:</strong> {{ object.image.name }}</p>
                                        <p class="text-muted mb-0">Upload a new image to replace the current one.</p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        {{ form.image }}
                        {% if form.image.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.image.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            Upload an image for the service. Supported formats: JPG, PNG, GIF, WebP. 
                            Maximum size: 5MB. Recommended dimensions: 400x300 pixels.
                        </div>
                        
                        <!-- Image Preview -->
                        <div id="image-preview" class="mt-3" style="display: none;">
                            <img id="preview-img" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'admin_panel:service_list' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-{% if form_action == 'Create' %}plus-circle{% else %}check-circle{% endif %} me-2"></i>
                            {{ form_action }} Service
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Help Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li><strong>Service Name:</strong> Use clear, descriptive names that customers will understand.</li>
                    <li><strong>Description:</strong> Include details about what the service includes and any special requirements.</li>
                    <li><strong>Base Price:</strong> Set a competitive base price. You can add pricing variants for different vehicle types later.</li>
                    <li><strong>Duration:</strong> Provide realistic time estimates to help with scheduling.</li>
                    <li><strong>Image:</strong> High-quality images help customers understand the service better.</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Image preview functionality
    $('#{{ form.image.id_for_label }}').change(function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#preview-img').attr('src', e.target.result);
                $('#image-preview').show();
            };
            reader.readAsDataURL(file);
        } else {
            $('#image-preview').hide();
        }
    });
    
    // Form validation
    $('#service-form').submit(function(e) {
        let isValid = true;
        
        // Clear previous error states
        $('.form-control, .form-select').removeClass('is-invalid');
        
        // Validate required fields
        const requiredFields = ['{{ form.name.id_for_label }}', '{{ form.description.id_for_label }}', 
                               '{{ form.category.id_for_label }}', '{{ form.base_price.id_for_label }}', 
                               '{{ form.estimated_duration.id_for_label }}'];
        
        requiredFields.forEach(function(fieldId) {
            const field = $('#' + fieldId);
            if (!field.val() || field.val().trim() === '') {
                field.addClass('is-invalid');
                isValid = false;
            }
        });
        
        // Validate price is positive
        const price = parseFloat($('#{{ form.base_price.id_for_label }}').val());
        if (price <= 0) {
            $('#{{ form.base_price.id_for_label }}').addClass('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            $('html, body').animate({
                scrollTop: $('.is-invalid').first().offset().top - 100
            }, 500);
        }
    });
    
    // Auto-format duration input
    $('#{{ form.estimated_duration.id_for_label }}').on('blur', function() {
        let value = $(this).val();
        if (value && !value.includes(':')) {
            // If user enters just a number, assume it's hours
            const hours = parseFloat(value);
            if (!isNaN(hours)) {
                const h = Math.floor(hours);
                const m = Math.floor((hours - h) * 60);
                $(this).val(h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0') + ':00');
            }
        }
    });
    
    // Price formatting
    $('#{{ form.base_price.id_for_label }}').on('blur', function() {
        const value = parseFloat($(this).val());
        if (!isNaN(value)) {
            $(this).val(value.toFixed(2));
        }
    });
});
</script>
{% endblock %}