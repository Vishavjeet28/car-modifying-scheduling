{% extends 'base.html' %}
{% load static %}

{% block title %}AI Assistant - CarModX{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        max-width: 800px;
        margin: 0 auto;
        height: 70vh;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px 10px 0 0;
        border: 1px solid #dee2e6;
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message.ai {
        justify-content: flex-start;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message.user .message-bubble {
        background: #007bff;
        color: white;
    }
    
    .message.ai .message-bubble {
        background: white;
        border: 1px solid #dee2e6;
        color: #333;
    }
    
    .chat-input-container {
        display: flex;
        padding: 20px;
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 10px 10px;
    }
    
    .chat-input {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 25px;
        padding: 12px 20px;
        margin-right: 10px;
        outline: none;
    }
    
    .send-btn {
        border-radius: 50%;
        width: 50px;
        height: 50px;
        border: none;
        background: #007bff;
        color: white;
        cursor: pointer;
    }
    
    .send-btn:hover {
        background: #0056b3;
    }
    
    .typing-indicator {
        display: none;
        padding: 10px;
        font-style: italic;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-robot"></i> CarModX AI Assistant
            </h2>
            <p class="text-center text-muted mb-4">
                Ask me about our services, book appointments, or get help with your car modification needs!
            </p>
        </div>
    </div>
    
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <div class="message-bubble">
                    Hello! Welcome to CarModX. I'm your AI assistant. How can I help you with our car modification services today?
                </div>
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            AI is typing...
        </div>
        
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="messageInput" 
                   placeholder="Type your message here..." 
                   maxlength="500">
            <button class="send-btn" id="sendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class ChatInterface {
    constructor() {
        this.sessionId = null;
        this.messagesContainer = document.getElementById('chatMessages');
        this.messageInput = document.getElementById('messageInput');
        this.sendBtn = document.getElementById('sendBtn');
        this.typingIndicator = document.getElementById('typingIndicator');
        
        this.init();
    }
    
    init() {
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        this.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.sendMessage();
            }
        });
    }
    
    async sendMessage() {
        const message = this.messageInput.value.trim();
        if (!message) return;
        
        // Add user message to chat
        this.addMessage('user', message);
        this.messageInput.value = '';
        this.showTyping();
        
        try {
            const response = await fetch('/ai-agent/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    session_id: this.sessionId
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                this.sessionId = data.session_id;
                this.addMessage('ai', data.response);
            } else {
                this.addMessage('ai', 'Sorry, I encountered an error. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            this.addMessage('ai', 'Sorry, I\'m having trouble connecting. Please try again.');
        } finally {
            this.hideTyping();
        }
    }
    
    addMessage(sender, message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'message-bubble';
        bubbleDiv.textContent = message;
        
        messageDiv.appendChild(bubbleDiv);
        this.messagesContainer.appendChild(messageDiv);
        
        // Scroll to bottom
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
    }
    
    showTyping() {
        this.typingIndicator.style.display = 'block';
        this.sendBtn.disabled = true;
    }
    
    hideTyping() {
        this.typingIndicator.style.display = 'none';
        this.sendBtn.disabled = false;
    }
}

// Initialize chat when page loads
document.addEventListener('DOMContentLoaded', () => {
    new ChatInterface();
});
</script>
{% endblock %}